<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ח.סבן חומרי בנין PWA</title>
    <meta name="theme-color" content="#14b8a6">
    
    <!-- מלשינון שגיאות משודרג -->
    <script>
      window.addEventListener('error', function(event) {
        if (event.message?.includes('ResizeObserver')) return;
        var div = document.getElementById('debug-console');
        if (!div) {
          div = document.createElement('div');
          div.id = 'debug-console';
          div.style = "position:fixed; top:0; left:0; right:0; background:rgba(185, 28, 28, 0.95); color:white; padding:16px; z-index:99999; font-family:monospace; font-size:12px; direction:ltr; text-align:left; border-bottom: 2px solid #fff;";
          document.body.appendChild(div);
        }
        div.innerHTML += "<div><strong>⚠️ Error:</strong> " + event.message + "</div>";
      });
    </script>

    <!-- React Framework -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Routing -->
    <script crossorigin src="https://unpkg.com/history@5/umd/history.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router@6.3.0/umd/react-router.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.production.min.js"></script>
    
    <!-- JSX Compiler -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Styles & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { saban: { 500: '#14b8a6', 600: '#0d9488' } },
                    fontFamily: { sans: ['Heebo', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="icon" href="https://i.postimg.cc/d0Cxk6rK/lky-RRdh.jpg" />

    <style>
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.5); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { HashRouter, Routes, Route, Link, useNavigate, useParams, useLocation } = ReactRouterDOM;
        const { motion, AnimatePresence } = window.Motion;

        // --- 1. SEED DATA ---
        const PRODUCTS = [
            { id: 'p1', sku: 'QRTZ-001', title: 'שק קוורצית (גרנוליט) דק', price: 45, category: 'חומרי מליטה', brand: 'בטון עטרות', image: 'https://betonatarot.co.il/wp-content/uploads/2020/06/%D7%A9%D7%A7-%D7%A7%D7%95%D7%95%D7%A8%D7%A6%D7%99%D7%AA-17.5.2020-s-.jpg', description: 'אגרגט קוורץ טבעי בגוון לבן/קרם, משמש ליציקות דקורטיביות.', features: ['גודל גרגר: 1.2-2.5 מ"מ', 'משקל: 25 ק"ג'], technicalSpecs: { coverage: '50 ק"ג למ"ר', drying: '24 שעות', standard: 'ת"י 118' }, stock: 150 },
            { id: 'p2', sku: 'CMT-50', title: 'מלט אפור 50 ק"ג', price: 28, category: 'חומרי מליטה', brand: 'נשר', image: 'https://placehold.co/400x400/e2e8f0/1e293b?text=Cement', description: 'מלט פורטלנד איכותי לבנייה כללית.', features: ['חוזק גבוה B-30'], technicalSpecs: { coverage: 'משתנה', drying: '10 שעות', standard: 'ת"י 1' }, stock: 500 },
            { id: 'p3', sku: 'YTG-10', title: 'בלוק איטונג 10', price: 6.5, category: 'בלוקים', brand: 'איטונג', image: 'https://placehold.co/400x400/f1f5f9/334155?text=Ytong', description: 'בלוק לבן מבודד תרמית ואקוסטית.', features: ['בידוד תרמי מעולה'], technicalSpecs: { coverage: '10 יח׳ למ"ר', drying: '-', standard: 'ת"י 268' }, stock: 1200 }
        ];

        const CATEGORIES = [
            { id: 'all', name: 'הכל', icon: 'LayoutGrid' },
            { id: 'cement', name: 'מליטה', icon: 'Component' },
            { id: 'blocks', name: 'בלוקים', icon: 'Box' },
            { id: 'paint', name: 'צבע', icon: 'PaintBucket' },
            { id: 'tools', name: 'כלים', icon: 'Hammer' }
        ];

        const PHONE_NUMBER = "972508860896";

        // --- 2. COMPONENTS ---

        // FIX: רכיב אייקון יציב שמונע את קריסת React Error #130
        const Icon = ({ name, size = 20, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide && window.lucide.icons[name]) {
                    const svg = window.lucide.createElement(window.lucide.icons[name]);
                    svg.setAttribute('width', size);
                    svg.setAttribute('height', size);
                    if (className) svg.setAttribute('class', className);
                    ref.current.innerHTML = '';
                    ref.current.appendChild(svg);
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center" />;
        };

        const ChatWidget = () => {
            const [isOpen, setIsOpen] = useState(false);
            const [msgs, setMsgs] = useState([{role:'bot', text:'היי! אני הבוט של סבן. מחפש מוצר? (למשל "מלט")'}]);
            const [input, setInput] = useState('');
            const endRef = useRef(null);

            useEffect(() => endRef.current?.scrollIntoView({ behavior: 'smooth' }), [msgs, isOpen]);

            const send = () => {
                if(!input.trim()) return;
                const userMsg = { role: 'user', text: input };
                setMsgs(p => [...p, userMsg]);
                setInput('');
                
                setTimeout(() => {
                    let ans = "לא מצאתי מידע על זה. נסה לשאול על מחיר או מלאי.";
                    const term = userMsg.text.toLowerCase();
                    const product = PRODUCTS.find(p => p.title.includes(term) || p.sku.includes(term));
                    
                    if(product) {
                        ans = `מצאתי את ${product.title} במחיר ₪${product.price}. תרצה להוסיף לעגלה?`;
                    } else if(term.includes('שעות')) ans = "פתוחים א-ה 07:00-17:00.";
                    
                    setMsgs(p => [...p, { role: 'bot', text: ans }]);
                }, 600);
            };

            return (
                <>
                    <button onClick={() => setIsOpen(true)} className={`fixed bottom-24 left-4 z-40 p-3 bg-white text-saban-600 rounded-full shadow-xl transition-all ${isOpen ? 'scale-0' : 'scale-100'}`}>
                        <Icon name="Bot" size={28} />
                    </button>
                    <AnimatePresence>
                        {isOpen && (
                            <motion.div initial={{opacity:0, y:20}} animate={{opacity:1, y:0}} exit={{opacity:0, y:20}} className="fixed bottom-20 left-4 right-4 md:w-80 h-96 bg-white shadow-2xl rounded-2xl border z-50 flex flex-col overflow-hidden">
                                <div className="bg-saban-600 text-white p-3 flex justify-between items-center">
                                    <span className="font-bold flex gap-2"><Icon name="Bot" size={18}/> העוזר של סבן</span>
                                    <button onClick={() => setIsOpen(false)}><Icon name="X" size={18}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-50">
                                    {msgs.map((m, i) => (
                                        <div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}>
                                            <div className={`p-2 rounded-xl max-w-[85%] text-sm ${m.role==='user'?'bg-saban-600 text-white':'bg-white border text-gray-800'}`}>{m.text}</div>
                                        </div>
                                    ))}
                                    <div ref={endRef}></div>
                                </div>
                                <div className="p-2 border-t flex gap-2">
                                    <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} placeholder="הקלד..." className="flex-1 bg-gray-100 rounded-full px-3 text-sm outline-none" />
                                    <button onClick={send} className="bg-saban-600 text-white p-2 rounded-full"><Icon name="Send" size={16}/></button>
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </>
            );
        };

        const NavBar = ({ cartCount }) => {
            const loc = useLocation();
            const isActive = (p) => loc.pathname === p ? 'text-saban-600' : 'text-gray-400';
            return (
                <div className="fixed bottom-0 w-full bg-white glass pb-safe border-t z-30 h-16 flex justify-around items-center px-2">
                    <Link to="/" className={`flex flex-col items-center gap-1 text-[10px] font-medium ${isActive('/')}`}><Icon name="Home" size={22} /><span>ראשי</span></Link>
                    <Link to="/scan" className="flex flex-col items-center justify-center -mt-6"><div className="bg-saban-600 text-white p-3.5 rounded-full shadow-lg"><Icon name="ScanLine" size={24} /></div><span className="text-[10px] font-bold text-saban-600 mt-1">סרוק</span></Link>
                    <Link to="/cart" className={`flex flex-col items-center gap-1 text-[10px] font-medium relative ${isActive('/cart')}`}><Icon name="ShoppingCart" size={22} />{cartCount > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full">{cartCount}</span>}<span>עגלה</span></Link>
                </div>
            );
        };

        const HomePage = () => {
            const [search, setSearch] = useState('');
            const filtered = PRODUCTS.filter(p => p.title.includes(search));
            return (
                <div className="pt-4 pb-24 px-4">
                    <div className="flex justify-between items-center mb-6">
                        <div><h1 className="text-2xl font-black text-gray-800">ח.סבן</h1><p className="text-xs text-gray-500">אספקה טכנית לכולם</p></div>
                        <img src="https://ui-avatars.com/api/?name=Saban&background=0d9488&color=fff" className="w-10 h-10 rounded-full" />
                    </div>
                    <div className="relative mb-6">
                        <span className="absolute top-3.5 right-4 text-gray-400"><Icon name="Search" size={18}/></span>
                        <input value={search} onChange={e => setSearch(e.target.value)} className="w-full h-12 pr-12 pl-4 bg-white rounded-2xl shadow-sm outline-none" placeholder="חיפוש מוצר..." />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        {filtered.map(p => (
                            <Link to={`/product/${p.id}`} key={p.id} className="bg-white p-3 rounded-2xl shadow-sm flex flex-col h-full border border-gray-50 active:scale-95 transition">
                                <div className="aspect-square bg-gray-100 rounded-xl mb-3 overflow-hidden"><img src={p.image} className="w-full h-full object-cover mix-blend-multiply"/></div>
                                <h3 className="font-bold text-sm text-gray-800 line-clamp-2">{p.title}</h3>
                                <div className="mt-auto flex justify-between items-end"><span className="text-lg font-black text-saban-600">₪{p.price}</span><div className="w-7 h-7 bg-gray-100 rounded-full flex items-center justify-center text-saban-600"><Icon name="Plus" size={14} /></div></div>
                            </Link>
                        ))}
                    </div>
                </div>
            );
        };

        const ProductPage = ({ addToCart }) => {
            const { id } = useParams();
            const nav = useNavigate();
            const p = PRODUCTS.find(x => x.id === id);
            if(!p) return <div>לא נמצא</div>;
            return (
                <div className="bg-white min-h-screen pb-24">
                    <div className="relative h-72 bg-gray-100">
                        <img src={p.image} className="w-full h-full object-cover" />
                        <button onClick={() => nav(-1)} className="absolute top-4 right-4 w-10 h-10 bg-white/80 rounded-full flex items-center justify-center shadow-sm"><Icon name="ArrowRight" /></button>
                    </div>
                    <div className="-mt-6 relative z-10 bg-white rounded-t-3xl p-6 shadow-sm">
                        <div className="flex justify-between items-start mb-2"><div><h1 className="text-2xl font-black text-gray-900">{p.title}</h1><p className="text-xs text-gray-400">מק"ט: {p.sku}</p></div><div className="text-2xl font-black text-saban-600">₪{p.price}</div></div>
                        <div className="space-y-4 mt-4">
                            <section><h3 className="font-bold mb-1 text-sm">תיאור</h3><p className="text-sm text-gray-500">{p.description}</p></section>
                            <section><h3 className="font-bold mb-1 text-sm">נתונים</h3><div className="grid grid-cols-3 gap-2 text-center text-xs"><div className="bg-gray-50 p-2 rounded border"><strong>כיסוי</strong><br/>{p.technicalSpecs.coverage}</div><div className="bg-gray-50 p-2 rounded border"><strong>ייבוש</strong><br/>{p.technicalSpecs.drying}</div><div className="bg-gray-50 p-2 rounded border"><strong>תקן</strong><br/>{p.technicalSpecs.standard}</div></div></section>
                        </div>
                    </div>
                    <div className="fixed bottom-0 w-full p-4 bg-white border-t z-20 pb-safe">
                        <button onClick={() => addToCart(p)} className="w-full bg-saban-600 text-white py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">הוסף לעגלה <Icon name="ShoppingBag" size={18}/></button>
                    </div>
                </div>
            );
        };

        const CartPage = ({ cart, updateQty, clearCart }) => {
            const [form, setForm] = useState({ name: '', phone: '' });
            const total = cart.reduce((acc, i) => acc + (i.product.price * i.qty), 0);
            const send = () => {
                if(!form.name || !form.phone) return alert("חובה למלא שם וטלפון");
                let msg = `הזמנה חדשה:\n`;
                cart.forEach((item, i) => msg += `${i+1}. ${item.product.title} (x${item.qty})\n`);
                msg += `סה"כ: ₪${total}\nלקוח: ${form.name} ${form.phone}`;
                window.open(`https://wa.me/${PHONE_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
                if(confirm("לנקות סל?")) clearCart();
            };
            if(!cart.length) return <div className="h-screen flex flex-col items-center justify-center text-gray-400 gap-4"><Icon name="ShoppingCart" size={48} opacity={0.2} /><p>העגלה ריקה</p></div>;
            return (
                <div className="pt-6 pb-24 px-4 bg-gray-50 min-h-screen">
                    <h1 className="text-2xl font-black mb-6">הזמנה</h1>
                    <div className="space-y-3 mb-8">{cart.map(item => (<div key={item.product.id} className="bg-white p-3 rounded-xl shadow-sm flex gap-3"><div className="flex-1"><h4 className="font-bold text-sm">{item.product.title}</h4><div className="text-saban-600 font-bold">₪{item.product.price * item.qty}</div></div><div className="flex items-center gap-3"><button onClick={() => updateQty(item.product.id, -1)}>-</button><span className="font-bold">{item.qty}</span><button onClick={() => updateQty(item.product.id, 1)}>+</button></div></div>))}</div>
                    <div className="bg-white p-5 rounded-2xl shadow-sm space-y-3 mb-6"><input value={form.name} onChange={e=>setForm({...form, name:e.target.value})} placeholder="שם מלא *" className="w-full bg-gray-50 p-3 rounded-xl"/><input value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})} type="tel" placeholder="טלפון *" className="w-full bg-gray-50 p-3 rounded-xl"/></div>
                    <div className="fixed bottom-0 left-0 w-full bg-white p-4 border-t z-20 pb-safe"><button onClick={send} className="w-full bg-green-600 text-white py-3.5 rounded-xl font-bold shadow-lg flex justify-center gap-2">שלח לווטסאפ <Icon name="Send" size={18}/></button></div>
                </div>
            );
        };

        const App = () => {
            const [cart, setCart] = useState(() => JSON.parse(localStorage.getItem('saban_cart')||'[]'));
            useEffect(() => localStorage.setItem('saban_cart', JSON.stringify(cart)), [cart]);
            const addToCart = (p) => {
                setCart(prev => {
                    const exist = prev.find(i => i.product.id === p.id);
                    if(exist) return prev.map(i => i.product.id === p.id ? {...i, qty: i.qty+1} : i);
                    return [...prev, { product: p, qty: 1 }];
                });
                alert("מוצר נוסף!");
            };
            const updateQty = (pid, delta) => {
                setCart(prev => {
                    if(delta === 0) return prev.filter(i => i.product.id !== pid);
                    return prev.map(i => {
                        if(i.product.id === pid) return { ...i, qty: Math.max(0, i.qty + delta) };
                        return i;
                    }).filter(i => i.qty > 0);
                });
            };
            return (
                <HashRouter>
                    <div className="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative overflow-hidden">
                        <Routes>
                            <Route path="/" element={<HomePage />} />
                            <Route path="/product/:id" element={<ProductPage addToCart={addToCart} />} />
                            <Route path="/cart" element={<CartPage cart={cart} updateQty={updateQty} clearCart={()=>setCart([])} />} />
                            <Route path="/scan" element={<div className="h-screen flex items-center justify-center bg-black text-white p-10 text-center"><Icon name="ScanLine" size={64}/><br/>סריקה... (סימולציה)</div>} />
                        </Routes>
                        <ChatWidget />
                        <NavBar cartCount={cart.reduce((a,b)=>a+b.qty,0)} />
                    </div>
                </HashRouter>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
